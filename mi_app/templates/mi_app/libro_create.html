{% extends 'base.html' %}

{% block title %}Agregar Libro{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3>Agregar Nuevo Libro</h3>
            </div>
            <div class="card-body">
                <form method="post" id="libroForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="{{ form.titulo.id_for_label }}" class="form-label">Título</label>
                        {{ form.titulo }}
                        {% if form.titulo.errors %}
                            <div class="text-danger">{{ form.titulo.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.autor.id_for_label }}" class="form-label">Autor</label>
                        {{ form.autor }}
                        {% if form.autor.errors %}
                            <div class="text-danger">{{ form.autor.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.genero.id_for_label }}" class="form-label">Género</label>
                            {{ form.genero }}
                            {% if form.genero.errors %}
                                <div class="text-danger">{{ form.genero.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.fecha_publicacion.id_for_label }}" class="form-label">Fecha de Publicación</label>
                            {{ form.fecha_publicacion }}
                            {% if form.fecha_publicacion.errors %}
                                <div class="text-danger">{{ form.fecha_publicacion.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.isbn.id_for_label }}" class="form-label">ISBN</label>
                            {{ form.isbn }}
                            {% if form.isbn.errors %}
                                <div class="text-danger">{{ form.isbn.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.precio.id_for_label }}" class="form-label">Precio</label>
                            {{ form.precio }}
                            {% if form.precio.errors %}
                                <div class="text-danger">{{ form.precio.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.sinopsis.id_for_label }}" class="form-label">Sinopsis</label>
                        {{ form.sinopsis }}
                        {% if form.sinopsis.errors %}
                            <div class="text-danger">{{ form.sinopsis.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'libro_list' %}" class="btn btn-secondary me-md-2" onclick="clearFormData()">Cancelar</a>
                        <button type="submit" class="btn btn-primary">Guardar Libro</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Guardar datos del formulario en localStorage
function saveFormData() {
    const form = document.getElementById('libroForm');
    const formData = new FormData(form);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    localStorage.setItem('libroFormData', JSON.stringify(data));
}

// Cargar datos del formulario desde localStorage
function loadFormData() {
    const savedData = localStorage.getItem('libroFormData');
    if (savedData) {
        const data = JSON.parse(savedData);
        const form = document.getElementById('libroForm');
        
        for (let key in data) {
            const field = form.querySelector(`[name="${key}"]`);
            if (field) {
                field.value = data[key];
            }
        }
    }
}

// Limpiar datos del formulario
function clearFormData() {
    localStorage.removeItem('libroFormData');
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    loadFormData();
    
    // Guardar datos cuando cambie cualquier campo
    const form = document.getElementById('libroForm');
    form.addEventListener('input', saveFormData);
    
    // Limpiar datos cuando se envíe el formulario exitosamente
    form.addEventListener('submit', function() {
        if (form.checkValidity()) {
            clearFormData();
        }
    });
});

// Advertencia antes de salir si hay datos sin guardar
window.addEventListener('beforeunload', function(e) {
    const savedData = localStorage.getItem('libroFormData');
    if (savedData) {
        const data = JSON.parse(savedData);
        const hasData = Object.values(data).some(value => value.trim() !== '');
        
        if (hasData) {
            e.preventDefault();
            e.returnValue = 'Tienes datos sin guardar. ¿Estás seguro de que quieres salir?';
        }
    }
});
</script>
{% endblock %}